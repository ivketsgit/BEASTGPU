using Test
using LinearAlgebra

using CompScienceMeshes
using BEAST
using BenchmarkTools
#using Serialization

for T in [Float32]
    println("\n\n\n\n\n\n\n\n\n==================NEW TEST=====================")
    κ = ω = T(1.0)

    Γ = meshsegment(T(5.0), T(0.5))
    X = lagrangec0d1(Γ)
    @test numvertices(Γ)-2 == numfunctions(X)

    hypersingular = HyperSingular(κ)
    identityop    = Identity()
    doublelayer   = DoubleLayer(κ)

    @show BEAST.defaultquadstrat(hypersingular, X, X)
    # @show @which BEAST.defaultquadstrat(hypersingular, X, X)
    N = assemble(hypersingular, X, X)
    #@time I = Matrix(assemble(identityop, X, X))

    println(N)
    #println(typeof(N))
    #serialize("N.bin",N)
    #a = deserialize("N.bin")
    #println(a == N)
    #println(deserialize("N.bin"))
    #println(N, I)
    #println(N == deserialize("N.bin"))
end

a = ComplexF64[0.3487327758220423 + 0.030927511201088526im -0.10012977772124428 + 0.029980917764602183im -0.06814300700368667 + 0.0272570203019242im -0.0201362721869454 + 0.023085743759599764im -0.004480266928750129 + 0.017960882688535164im 0.003003201718934187 + 0.012466084848003411im 0.006338550820102165 + 0.007189456900082061im 0.0070469539755104935 + 0.0026410243441586517im 0.006062735739908574 - 0.0008136665514491548im; -0.100129769589402 + 0.029980917108393457im 0.34873274705908963 + 0.030927511660983703im -0.10012977358071658 + 0.029980917610549274im -0.06814300198816496 + 0.02725702317050771im -0.020136279697095222 + 0.023085742944144783im -0.004480266928750129 + 0.017960882688535164im 0.003003201718934187 + 0.012466084848003411im 0.0063385498514522826 + 0.007189460229999736im 0.007046945724594182 + 0.0026410233069310146im; -0.06814300529932739 + 0.027257019389621356im -0.100129769589402 + 0.029980917108393457im 0.34873274705908963 + 0.030927511660983703im -0.10012975531355506 + 0.029980921396647847im -0.06814302530705368 + 0.02725702078798556im -0.020136279697095222 + 0.023085742944144783im -0.004480266928750129 + 0.017960882688535164im 0.0030031992002035185 + 0.012466087629414261im 0.006338551123297884 + 0.007189455976064546im; -0.020136275333249506 + 0.023085737999444397im -0.06814300529932739 + 0.027257019389621356im -0.100129769589402 + 0.029980917108393457im 0.3487327022934509 + 0.030927515686074825im -0.10012972491337047 + 0.02998091786989701im -0.06814302530705368 + 0.02725702078798556im -0.020136279697095222 + 0.023085742944144783im -0.004480270724801325 + 0.017960884311250716im 0.0030032025214888763 + 0.012466083921969368im; -0.004480266260159044 + 0.01796088676860002im -0.020136275333249506 + 0.023085737999444397im -0.06814300529932739 + 0.027257019389621356im -0.10012979999008781 + 0.029980920635144043im 0.3487327470595222 + 0.03092751166098362im -0.10012972491337047 + 0.02998091786989701im -0.06814302530705368 + 0.02725702078798556im -0.020136284370009902 + 0.02308574301154767im -0.004480265459016586 + 0.017960881878936324im; 0.0030032030036000884 + 0.012466079813076443im -0.004480266260159044 + 0.01796088676860002im -0.020136275333249506 + 0.023085737999444397im -0.06814298198045785 + 0.027257021772143203im -0.10012981825723158 + 0.029980916849045414im 0.3487327470595222 + 0.03092751166098362im -0.10012972491337047 + 0.02998091786989701im -0.06814303072614267 + 0.027257019207060057im -0.020136277067912364 + 0.023085742352435518im; 0.006338550403103854 + 0.0071894554435694355im 0.0030032030036000884 + 0.012466079813076443im -0.004480266260159044 + 0.01796088676860002im -0.020136267823100712 + 0.02308573881489913im -0.06814298699597895 + 0.027257018903559888im -0.10012981825723158 + 0.029980916849045414im 0.3487327470595222 + 0.03092751166098362im -0.10012973309605336 + 0.02998091487802171im -0.06814301899060554 + 0.02725702048212139im; 0.007046947363855242 + 0.002641021504708546im 0.006338549251931391 + 0.007189454589052388im 0.003003202305702307 + 0.012466078433295214im -0.004480261874882263 + 0.017960881923057163im -0.020136271994796215 + 0.023085738349036433im -0.06814298645537092 + 0.027257017115372678im -0.1001298344139039 + 0.029980915746306624im 0.3487330197299595 + 0.030927507579138147im -0.10013002016991977 + 0.029980918611368645im; 0.0060627370944012745 - 0.0008136651760609626im 0.007046948705288263 + 0.002641021914420477im 0.0063385503463094656 + 0.007189455620535044im 0.003003206611768283 + 0.012466082175676449im -0.00448026400341979 + 0.01796088010472189im -0.02013627168092484 + 0.02308574039718131im -0.06814296807796225 + 0.02725701865372704im -0.10013006068690096 + 0.02998091242615228im 0.34873320286880927 + 0.030927511547475306im] 
b = ComplexF64[0.34873275458812714 + 0.03092747926712036im -0.10012985020875931 + 0.02998104691505432im  -0.06814534589648247 + 0.02726075053215027im -0.02015737257897854 + 0.02313188835978508im -0.004586987197399139 + 0.018297036178410053im 0.0026662051677703857 + 0.014179282821714878im 0.005721196532249451 + 0.013971136882901192im 0.007111761718988419 + 0.024924322962760925im 0.011624888516962528 + 0.06271038949489594im; -0.10012985020875931 + 0.029981032013893127im 0.34873275458812714 + 0.03092747926712036im -0.10012985020875931 + 0.02998104691505432im -0.06814534030854702 + 0.02726075053215027im -0.020157380029559135 + 0.023131880909204483im -0.004586987197399139 + 0.018297036178410053im 0.0026662051677703857 + 0.014179282821714878im 0.005721189081668854 + 0.013971148058772087im 0.007111743558198214 + 0.024924345314502716im; -0.06814534589648247 + 0.02726075053215027im -0.10012985020875931 + 0.029981032013893127im 0.34873275458812714 + 0.03092747926712036im -0.10012982785701752 + 0.02998104691505432im -0.06814535520970821 + 0.02726075053215027im -0.020157380029559135 + 0.023131880909204483im -0.004586987197399139 + 0.018297036178410053im 0.0026662126183509827 + 0.014179288409650326im 0.005721189081668854 + 0.01397114060819149im; -0.020157402381300926 + 0.02313188463449478im -0.06814534589648247 + 0.02726075053215027im -0.10012985020875931 + 0.029981032013893127im 0.34873268008232117 + 0.030927494168281555im -0.10012982785701752 + 0.029981032013893127im -0.06814535520970821 + 0.02726075053215027im -0.020157380029559135 + 0.023131880909204483im -0.0045869722962379456 + 0.018297037109732628im 0.0026662126183509827 + 0.014179286547005177im; -0.004586987197399139 + 0.018297038972377777im -0.020157402381300926 + 0.02313188463449478im -0.06814534589648247 + 0.02726075053215027im -0.10012991726398468 + 0.02998104691505432im 0.34873272478580475 + 0.03092750906944275im -0.10012982785701752 + 0.029981032013893127im -0.06814535520970821 + 0.02726075053215027im -0.020157380029559135 + 0.02313188463449478im -0.004586964845657349 + 0.01829703338444233im; 0.002666197717189789 + 0.014179278165102005im -0.004586987197399139 + 0.018297038972377777im -0.020157402381300926 + 0.02313188463449478im -0.06814531423151493 + 0.02726075053215027im -0.10012993216514587 + 0.02998104691505432im 0.34873272478580475 + 0.03092750906944275im -0.10012982785701752 + 0.029981032013893127im -0.06814536452293396 + 0.027260735630989075im -0.02015736885368824 + 0.02313188463449478im; 0.005721185356378555 + 0.013971136882901192im 0.002666197717189789 + 0.014179278165102005im -0.004586987197399139 + 0.018297038972377777im -0.02015739679336548 + 0.02313189208507538im -0.06814531795680523 + 0.027260765433311462im -0.10012993216514587 + 0.02998104691505432im 0.34873272478580475 + 0.03092750906944275im -0.10012983903288841 + 0.029981032013893127im -0.06814536079764366 + 0.027260735630989075im; 0.007111756596714258 + 0.024924322962760925im 0.00572117418050766 + 0.013971133157610893im 0.0026662051677703857 + 0.014179276302456856im -0.0045869797468185425 + 0.01829703152179718im -0.020157381892204285 + 0.02313188835978508im -0.06814530491828918 + 0.027260765433311462im -0.10012993402779102 + 0.029981017112731934im 0.34873297810554504 + 0.03092750906944275im -0.10013014450669289 + 0.02998104691505432im; 0.011624887585639954 + 0.06271039694547653im 0.007111749146133661 + 0.024924322962760925im 0.005721196532249451 + 0.013971133157610893im 0.002666197717189789 + 0.014179280027747154im -0.0045869722962379456 + 0.01829702965915203im -0.020157387480139732 + 0.023131880909204483im -0.0681452788412571 + 0.027260765433311462im -0.10013015009462833 + 0.029981017112731934im 0.34873315691947937 + 0.030927523970603943im]

c = ComplexF64[0.34873275458812714 + 0.03092750906944275im -0.1001298800110817 + 0.02998104691505432im -0.06814534775912762 + 0.02726075053215027im -0.02015737257897854 + 0.02313188835978508im -0.004586987197399139 + 0.018297037109732628im 0.002666197717189789 + 0.014179282821714878im 0.005721189081668854 + 0.01397114060819149im 0.007111761253327131 + 0.024924330413341522im 0.011624886188656092 + 0.06271038576960564im; -0.10012985020875931 + 0.029981032013893127im 0.34873275458812714 + 0.03092750906944275im -0.1001298800110817 + 0.02998104691505432im -0.06814534217119217 + 0.02726075053215027im -0.02015737257897854 + 0.023131880909204483im -0.004586987197399139 + 0.018297037109732628im 0.002666197717189789 + 0.014179282821714878im 0.005721189081668854 + 0.013971148058772087im 0.007111744023859501 + 0.024924345314502716im; -0.06814533285796642 + 0.02726075053215027im -0.10012985020875931 + 0.029981032013893127im 0.34873275458812714 + 0.03092750906944275im -0.1001298576593399 + 0.02998104691505432im -0.06814535707235336 + 0.02726075053215027im -0.02015737257897854 + 0.023131880909204483im -0.004586987197399139 + 0.018297037109732628im 0.002666197717189789 + 0.014179288409650326im 0.005721196532249451 + 0.013971144333481789im; -0.020157402381300926 + 0.02313188463449478im -0.06814533285796642 + 0.02726075053215027im -0.10012985020875931 + 0.029981032013893127im 0.34873268008232117 + 0.03092750906944275im -0.10012982785701752 + 0.029981032013893127im -0.06814535707235336 + 0.02726075053215027im -0.02015737257897854 + 0.023131880909204483im -0.0045869722962379456 + 0.018297038041055202im 0.002666197717189789 + 0.014179286547005177im; -0.0045869797468185425 + 0.018297025002539158im -0.020157402381300926 + 0.02313188463449478im -0.06814533285796642 + 0.02726075053215027im -0.10012991726398468 + 0.02998104691505432im 0.34873272478580475 + 0.03092750906944275im -0.10012982785701752 + 0.029981032013893127im -0.06814535707235336 + 0.02726075053215027im -0.020157387480139732 + 0.02313188463449478im -0.004586964845657349 + 0.018297030590474606im; 0.002666190266609192 + 0.014179274439811707im -0.0045869797468185425 + 0.018297025002539158im -0.020157402381300926 + 0.02313188463449478im -0.06814531423151493 + 0.02726075053215027im -0.10012993216514587 + 0.029981032013893127im 0.34873272478580475 + 0.03092750906944275im -0.10012982785701752 + 0.029981032013893127im -0.06814536824822426 + 0.027260735630989075im -0.020157383754849434 + 0.02313188463449478im; 0.005721177905797958 + 0.013971136882901192im 0.002666190266609192 + 0.014179274439811707im -0.0045869797468185425 + 0.018297025002539158im -0.02015739679336548 + 0.02313189208507538im -0.06814531795680523 + 0.027260765433311462im -0.10012993216514587 + 0.029981032013893127im 0.34873272478580475 + 0.03092750906944275im -0.10012984089553356 + 0.029981032013893127im -0.06814534775912762 + 0.027260735630989075im; 0.007111759856343269 + 0.024924330413341522im 0.00572117418050766 + 0.013971133157610893im 0.002666197717189789 + 0.014179272577166557im -0.0045869722962379456 + 0.01829702779650688im -0.020157381892204285 + 0.02313189208507538im -0.06814530491828918 + 0.027260765433311462im -0.10012994892895222 + 0.029981017112731934im 0.34873300790786743 + 0.03092750906944275im -0.10013014636933804 + 0.02998104691505432im; 0.011624889448285103 + 0.06271038576960564im 0.007111756131052971 + 0.024924322962760925im 0.005721196532249451 + 0.013971133157610893im 0.002666197717189789 + 0.014179276302456856im -0.0045869722962379456 + 0.018297025002539158im -0.020157385617494583 + 0.02313189208507538im -0.06814528070390224 + 0.02726075053215027im -0.10013015009462833 + 0.029981017112731934im 0.34873318672180176 + 0.030927523970603943im]
d = ComplexF64[0.3487327758220423 + 0.030927511201088526im -0.10012977772124428 + 0.029980917764602183im -0.06814300700368667 + 0.0272570203019242im -0.0201362721869454 + 0.023085743759599764im -0.004480266928750129 + 0.017960882688535164im 0.003003201718934187 + 0.012466084848003411im 0.006338550820102165 + 0.007189456900082061im 0.0070469539755104935 + 0.0026410243441586517im 0.006062735739908574 - 0.0008136665514491548im; -0.100129769589402 + 0.029980917108393457im 0.34873274705908963 + 0.030927511660983703im -0.10012977358071658 + 0.029980917610549274im -0.06814300198816496 + 0.02725702317050771im -0.020136279697095222 + 0.023085742944144783im -0.004480266928750129 + 0.017960882688535164im 0.003003201718934187 + 0.012466084848003411im 0.0063385498514522826 + 0.007189460229999736im 0.007046945724594182 + 0.0026410233069310146im; -0.06814300529932739 + 0.027257019389621356im -0.100129769589402 + 0.029980917108393457im 0.34873274705908963 + 0.030927511660983703im -0.10012975531355506 + 0.029980921396647847im -0.06814302530705368 + 0.02725702078798556im -0.020136279697095222 + 0.023085742944144783im -0.004480266928750129 + 0.017960882688535164im 0.0030031992002035185 + 0.012466087629414261im 0.006338551123297884 + 0.007189455976064546im; -0.020136275333249506 + 0.023085737999444397im -0.06814300529932739 + 0.027257019389621356im -0.100129769589402 + 0.029980917108393457im 0.3487327022934509 + 0.030927515686074825im -0.10012972491337047 + 0.02998091786989701im -0.06814302530705368 + 0.02725702078798556im -0.020136279697095222 + 0.023085742944144783im -0.004480270724801325 + 0.017960884311250716im 0.0030032025214888763 + 0.012466083921969368im; -0.004480266260159044 + 0.01796088676860002im -0.020136275333249506 + 0.023085737999444397im -0.06814300529932739 + 0.027257019389621356im -0.10012979999008781 + 0.029980920635144043im 0.3487327470595222 + 0.03092751166098362im -0.10012972491337047 + 0.02998091786989701im -0.06814302530705368 + 0.02725702078798556im -0.020136284370009902 + 0.02308574301154767im -0.004480265459016586 + 0.017960881878936324im; 0.0030032030036000884 + 0.012466079813076443im -0.004480266260159044 + 0.01796088676860002im -0.020136275333249506 + 0.023085737999444397im -0.06814298198045785 + 0.027257021772143203im -0.10012981825723158 + 0.029980916849045414im 0.3487327470595222 + 0.03092751166098362im -0.10012972491337047 + 0.02998091786989701im -0.06814303072614267 + 0.027257019207060057im -0.020136277067912364 + 0.023085742352435518im; 0.006338550403103854 + 0.0071894554435694355im 0.0030032030036000884 + 0.012466079813076443im -0.004480266260159044 + 0.01796088676860002im -0.020136267823100712 + 0.02308573881489913im -0.06814298699597895 + 0.027257018903559888im -0.10012981825723158 + 0.029980916849045414im 0.3487327470595222 + 0.03092751166098362im -0.10012973309605336 + 0.02998091487802171im -0.06814301899060554 + 0.02725702048212139im; 0.007046947363855242 + 0.002641021504708546im 0.006338549251931391 + 0.007189454589052388im 0.003003202305702307 + 0.012466078433295214im -0.004480261874882263 + 0.017960881923057163im -0.020136271994796215 + 0.023085738349036433im -0.06814298645537092 + 0.027257017115372678im -0.1001298344139039 + 0.029980915746306624im 0.3487330197299595 + 0.030927507579138147im -0.10013002016991977 + 0.029980918611368645im; 0.0060627370944012745 - 0.0008136651760609626im 0.007046948705288263 + 0.002641021914420477im 0.0063385503463094656 + 0.007189455620535044im 0.003003206611768283 + 0.012466082175676449im -0.00448026400341979 + 0.01796088010472189im -0.02013627168092484 + 0.02308574039718131im -0.06814296807796225 + 0.02725701865372704im -0.10013006068690096 + 0.02998091242615228im 0.34873320286880927 + 0.030927511547475306im]

length(a)
length(b)
sum(a-c)
sum(a-b)


a = [[1 2 3], [4 5 6], [7 8 9]]
c = rand(4, 3)
d = [(name = "Alice", age = 11, city = "New York"), (name = "bob", age = 22, city = "gent"), (name = "Chate", age = 33, city = "3"),(name = "Dirk", age = 44, city = "4")]
for i in c
    for j in i
        println(j)
    end
end
using CUDA
d_ = [[b for b in entry] for entry in d]
womps_weights = CuArray{Float32}(c)





